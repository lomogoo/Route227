<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒƒãƒ—ï¼ˆä»™å°ï¼‰</title>

  <!-- Leaflet CSS -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />

  <!-- åŸºæœ¬ã‚¹ã‚¿ã‚¤ãƒ«ï¼ˆæœ€å°é™ï¼‰ -->
  <style>
    :root{
      --color-bg:#FDFBF7;
      --color-text:#3D352E;
      --color-primary:#ee7501;
      --radius-lg:20px;
      --shadow-lg:0 8px 24px rgba(61,53,46,0.12);
    }
    html,body{height:100%;}
    body{
      margin:0;
      font-family: "Noto Sans JP", system-ui, -apple-system, sans-serif;
      background:var(--color-bg);
      color:var(--color-text);
      -webkit-font-smoothing:antialiased;
    }
    header{
      position:sticky; top:0; z-index:1000;
      background:rgba(253,251,247,0.85);
      -webkit-backdrop-filter: blur(12px);
      backdrop-filter: blur(12px);
      padding:12px 16px;
      display:flex; align-items:center; gap:12px;
      border-bottom:1px solid #F0EBE5;
    }
    header h1{
      margin:0; font-size:16px; font-weight:700;
    }
    #map{
      position:relative;
      height: calc(100dvh - 56px); /* å…¨ç”»é¢ï¼ˆãƒ˜ãƒƒãƒ€ãƒ¼å·®ã—å¼•ãï¼‰ */
      width: 100%;
      z-index: 1;
    }

    /* ã‚µãƒ ãƒä¸¸ãƒãƒ¼ã‚«ãƒ¼ï¼ˆDivIconï¼‰ */
    .thumb-marker{
      width:38px; height:38px;
      border-radius:50%;
      background-size: cover;
      background-position:center;
      background-color:#fff;
      border: 2px solid #fff;
      box-shadow: 0 2px 8px rgba(0,0,0,.2);
    }
    .thumb-marker--fallback{
      display:grid; place-items:center;
      font-size:18px; line-height:1;
      background: #fff;
      color:#999;
    }

    /* Leafletã®ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã‚’ã‚«ãƒ¼ãƒ‰é¢¨ã« */
    .leaflet-popup-content-wrapper{
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-lg);
    }
    .leaflet-popup-content{
      margin:0;
      padding:0;
      overflow:hidden;
      max-width: 320px;
    }
    .event-card{
      display:grid; grid-template-columns: 1fr;
    }
    .event-card__image{
      width:100%; height:160px; object-fit:cover; background:#eee;
      display:block;
    }
    .event-card__body{
      padding:12px 14px 14px;
      display:grid; gap:6px;
    }
    .event-card__title{
      font-weight:700; font-size:16px; margin:0;
    }
    .event-card__meta{
      font-size:12px; color:#6c757d;
      display:grid; gap:2px;
    }
    .event-card__desc{
      font-size:13px; line-height:1.5; margin:4px 0 0;
      white-space:pre-line;
    }
    .event-card__actions{
      display:flex; gap:8px; padding: 0 14px 12px;
    }
    .btn{
      appearance:none; border:none; cursor:pointer;
      padding:10px 14px; border-radius:12px;
      font-weight:700; font-size:13px;
      background:#EAE5E1; color:var(--color-text);
    }
    .btn--primary{ background:var(--color-primary); color:#fff; }
    .btn:active{ transform: translateY(1px); }

    /* å³ä¸‹ã«ã€Œç¾åœ¨åœ°ã¸ã€ãƒœã‚¿ãƒ³ */
    .locate-btn{
      position: absolute; right: 12px; bottom: 12px; z-index: 500;
      background:#fff; border:1px solid #eee; border-radius:12px;
      box-shadow: var(--shadow-lg);
      padding:10px 12px; font-weight:700; font-size:13px; cursor:pointer;
    }

    @media (max-width:480px){
      .event-card__image{ height: 140px; }
    }
  </style>
</head>
<body>
  <header>
    <h1>ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒƒãƒ—ï¼ˆä»™å°ï¼‰</h1>
  </header>

  <div id="map" role="region" aria-label="ã‚¤ãƒ™ãƒ³ãƒˆåœ°å›³"></div>
  <button class="locate-btn" id="locate-btn">ç¾åœ¨åœ°ã¸</button>

  <!-- Leaflet JS -->
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""
  ></script>

  <!-- Supabase JS -->
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>

  <script>
    // ====== 1) Supabase åˆæœŸåŒ–ï¼ˆæ—¢å­˜ã®å€¤ã«åˆã‚ã›ã¦ã‚ã‚Šã¾ã™ï¼‰ ======
    const { createClient } = window.supabase;
    const supabase = createClient(
      'https://hccairtzksnnqdujalgv.supabase.co',
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImhjY2FpcnR6a3NubnFkdWphbGd2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDkyNjI2MTYsImV4cCI6MjA2NDgzODYxNn0.TVDucIs5ClTWuykg_fy4yv65Rg-xbSIPFIfvIYawy_k'
    );

    // ====== 2) Leaflet ãƒãƒƒãƒ—åˆæœŸåŒ–ï¼ˆä»™å°ä¸­å¿ƒï¼‰ ======
    const MAP_CENTER = [38.2682, 140.8694]; // ä»™å°
    const map = L.map('map', {
      zoomControl: true,
      attributionControl: true
    }).setView(MAP_CENTER, 12);

    // ã‚¿ã‚¤ãƒ«ï¼ˆOpenStreetMapï¼‰
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{
      maxZoom: 19,
      attribution:'&copy; OpenStreetMap contributors'
    }).addTo(map);

    // ====== 3) ã‚¤ãƒ™ãƒ³ãƒˆã‚’èª­ã¿è¾¼ã‚€ï¼ˆãƒ†ãƒ¼ãƒ–ãƒ«ä¾‹: eventsï¼‰ ======
    // æƒ³å®šã‚¹ã‚­ãƒ¼ãƒ:
    // id, title, description, address, lat, lng, start_time, end_time, thumbnail_url
    async function fetchEvents(){
      const { data, error } = await supabase
        .from('events')
        .select('id,title,description,address,lat,lng,start_time,end_time,thumbnail_url')
        .order('start_time', { ascending: true });

      if(error){
        console.error('ã‚¤ãƒ™ãƒ³ãƒˆå–å¾—å¤±æ•—:', error);
        return [];
      }
      return data || [];
    }

    // ====== 4) ä½æ‰€â†’ç·¯åº¦çµŒåº¦ ã®ã‚¸ã‚ªã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ï¼ˆNominatim ã‚’åˆ©ç”¨ï¼‰ ======
    // â€» å…¬é–‹ã‚µã‚¤ãƒˆã§ä½¿ã†å ´åˆã¯ rate limit ã«æ³¨æ„ã€‚ã‚¢ãƒ—ãƒªã®é€£çµ¡å…ˆ email ã‚’è¨­å®šã—ã¦ãã ã•ã„ã€‚
    async function geocodeAddress(address){
      if(!address) return null;
      const url = new URL('https://nominatim.openstreetmap.org/search');
      url.searchParams.set('format','json');
      url.searchParams.set('q', address);
      url.searchParams.set('countrycodes','jp');
      url.searchParams.set('limit','1');
      url.searchParams.set('accept-language', 'ja');
      url.searchParams.set('email', 'example@example.com'); // â†é€£çµ¡å…ˆãƒ¡ãƒ¼ãƒ«ã«å·®ã—æ›¿ãˆæ¨å¥¨

      try{
        const res = await fetch(url.toString(), {
          headers: {
            'Accept':'application/json'
          }
        });
        if(!res.ok) return null;
        const json = await res.json();
        if(Array.isArray(json) && json.length){
          return [ parseFloat(json[0].lat), parseFloat(json[0].lon) ];
        }
      }catch(e){
        console.warn('Geocodingå¤±æ•—:', e);
      }
      return null;
    }

    // ä½æ‰€ã§ã‚¸ã‚ªã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ãŒæˆåŠŸã—ãŸã‚‰ã€ãã®çµæœã‚’Supabaseã«ã‚­ãƒ£ãƒƒã‚·ãƒ¥ï¼ˆlat/lngæ›´æ–°ï¼‰
    async function maybeCacheLatLng(eventId, lat, lng){
      try{
        await supabase.from('events')
          .update({ lat, lng })
          .eq('id', eventId);
      }catch(e){
        console.warn('lat/lngã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥ä¿å­˜å¤±æ•—:', e);
      }
    }

    // ====== 5) ã‚µãƒ ãƒä¸¸ã‚¢ã‚¤ã‚³ãƒ³ï¼ˆDivIconï¼‰ ======
    function thumbDivIcon(url){
      if(url){
        return L.divIcon({
          className: '',
          html: `<div class="thumb-marker" style="background-image:url('${escapeHtml(url)}')"></div>`,
          iconSize: [38,38],
          iconAnchor: [19,19],
          popupAnchor: [0,-16]
        });
      }else{
        return L.divIcon({
          className: '',
          html: `<div class="thumb-marker thumb-marker--fallback">ğŸ“</div>`,
          iconSize: [38,38],
          iconAnchor: [19,19],
          popupAnchor: [0,-16]
        });
      }
    }

    // ====== 6) ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã®ä¸­èº«ï¼ˆã‚«ãƒ¼ãƒ‰ï¼‰ ======
    function eventPopupHtml(ev){
      const start = formatDateTime(ev.start_time);
      const end   = formatDateTime(ev.end_time);
      const when  = (start && end) ? `${start} ã€œ ${end}` : (start || '');
      const addr  = ev.address ? escapeHtml(ev.address) : '';

      const img  = ev.thumbnail_url ? `<img class="event-card__image" src="${escapeHtml(ev.thumbnail_url)}" alt="">` : '';
      const desc = ev.description ? `<p class="event-card__desc">${escapeHtml(ev.description)}</p>` : '';

      return `
        <article class="event-card">
          ${img}
          <div class="event-card__body">
            <h2 class="event-card__title">${escapeHtml(ev.title || 'ã‚¤ãƒ™ãƒ³ãƒˆ')}</h2>
            <div class="event-card__meta">
              ${when ? `<div>ğŸ—“ ${when}</div>` : ''}
              ${addr ? `<div>ğŸ“ ${addr}</div>` : ''}
            </div>
            ${desc}
          </div>
          <div class="event-card__actions">
            ${addr ? `<button class="btn" onclick="openInMaps('${encodeURIComponent(ev.address)}')">åœ°å›³ã‚¢ãƒ—ãƒªã§é–‹ã</button>` : ''}
            <button class="btn btn--primary" onclick="shareEvent('${encodeURIComponent(ev.title||'ã‚¤ãƒ™ãƒ³ãƒˆ')}', '${encodeURIComponent(window.location.href)}')">å…±æœ‰</button>
          </div>
        </article>
      `;
    }

    // ====== 7) ãƒãƒ¼ã‚«ãƒ¼é…ç½® ======
    async function render(){
      const events = await fetchEvents();
      if(!events.length){
        console.info('ã‚¤ãƒ™ãƒ³ãƒˆãŒã‚ã‚Šã¾ã›ã‚“');
        return;
      }

      const bounds = L.latLngBounds();

      for(const ev of events){
        let lat = ev.lat, lng = ev.lng;

        // åº§æ¨™ãŒç„¡ã„å ´åˆã¯ä½æ‰€ã‹ã‚‰ã‚¸ã‚ªã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°
        if((lat==null || lng==null) && ev.address){
          const coords = await geocodeAddress(ev.address);
          if(coords){
            lat = coords[0]; lng = coords[1];
            // å–å¾—ã§ããŸã‚‰DBã«ã‚­ãƒ£ãƒƒã‚·ãƒ¥
            maybeCacheLatLng(ev.id, lat, lng);
            // è»½ã„ã‚¦ã‚§ã‚¤ãƒˆï¼ˆNominatimã®ãƒ¬ãƒ¼ãƒˆåˆ¶å¾¡ï¼‰
            await wait(250);
          }
        }

        if(lat==null || lng==null){
          // å ´æ‰€ä¸æ˜ã¯ã‚¹ã‚­ãƒƒãƒ—
          continue;
        }

        const marker = L.marker([lat,lng], { icon: thumbDivIcon(ev.thumbnail_url) }).addTo(map);
        marker.bindPopup(eventPopupHtml(ev), { maxWidth: 360, minWidth: 260 });

        bounds.extend([lat,lng]);
      }

      // 1ä»¶ã ã‘ã§ã‚‚å°‘ã—ã‚ºãƒ¼ãƒ ã€è¤‡æ•°ã‚ã‚Œã°å…¨ä½“ã«ãƒ•ã‚£ãƒƒãƒˆ
      if(bounds.isValid()){
        map.fitBounds(bounds, { padding:[40,40] });
      }else{
        map.setView(MAP_CENTER, 12);
      }
    }

    // ====== 8) ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ ======
    function formatDateTime(iso){
      if(!iso) return '';
      try{
        const d = new Date(iso);
        const y = d.getFullYear();
        const m = String(d.getMonth()+1).padStart(2,'0');
        const day= String(d.getDate()).padStart(2,'0');
        const hh = String(d.getHours()).padStart(2,'0');
        const mm = String(d.getMinutes()).padStart(2,'0');
        return `${y}/${m}/${day} ${hh}:${mm}`;
      }catch{ return ''; }
    }
    function escapeHtml(str){
      if(str==null) return '';
      return String(str)
        .replace(/&/g,'&amp;')
        .replace(/</g,'&lt;')
        .replace(/>/g,'&gt;')
        .replace(/"/g,'&quot;')
        .replace(/'/g,'&#039;');
    }
    function wait(ms){ return new Promise(r=>setTimeout(r, ms)); }

    // å¤–éƒ¨ã‚¢ã‚¯ã‚·ãƒ§ãƒ³
    window.openInMaps = (encAddress)=>{
      const addr = decodeURIComponent(encAddress);
      // iOS/Android/PCå•ã‚ãšä½¿ãˆã‚‹Googleãƒãƒƒãƒ—ã‚’æ—¢å®šã«
      const url = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(addr)}`;
      window.open(url, '_blank');
    };
    window.shareEvent = async (encTitle, encUrl)=>{
      const title = decodeURIComponent(encTitle);
      const url   = decodeURIComponent(encUrl);
      if(navigator.share){
        try{ await navigator.share({title, url}); }catch{}
      }else{
        await navigator.clipboard.writeText(url);
        alert('URLã‚’ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ');
      }
    };

    // ç¾åœ¨åœ°ã¸
    document.getElementById('locate-btn').addEventListener('click', ()=>{
      if(!navigator.geolocation){
        alert('ä½ç½®æƒ…å ±ãŒåˆ©ç”¨ã§ãã¾ã›ã‚“');
        return;
      }
      navigator.geolocation.getCurrentPosition((pos)=>{
        const { latitude, longitude } = pos.coords;
        map.setView([latitude, longitude], 15);
        L.circleMarker([latitude, longitude], {
          radius: 6, color: '#2c7be5', fillColor: '#2c7be5', fillOpacity: .9
        }).addTo(map).bindTooltip('ç¾åœ¨åœ°');
      }, ()=>{
        alert('ç¾åœ¨åœ°ã‚’å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸ');
      }, { enableHighAccuracy:true, timeout:8000 });
    });

    // å®Ÿè¡Œ
    render();
  </script>
</body>
</html>
